// LIBRARY 
#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>

// CONNECT KE TELEGRAM
const char* ssid = ""; //Nama penyedia hotspot
const char* password = ""; //Password hotspot
#define BOT_TOKEN "" // token bot dari BotFather
#define CHAT_ID   "" // chat id tujuan

// Deklarasi Pin
#define MQ2_PIN 34 //Pin sensor mq2 
#define MQ135_PIN 32 //Pin sensor mq135
#define BUZZER_PIN 16 //Pin Buzzer

// untuk menghubungkan ke telegram
WiFiClientSecure secured_client;
UniversalTelegramBot bot(BOT_TOKEN, secured_client);

int batasAman = 1000; //Batas aman

void setup() {
  Serial.begin(9600); // komunikasi baudrate

  // Menguhungkan ke koneksi hotspot
  WiFi.begin(ssid, password);
  secured_client.setInsecure(); // Nonaktifkan sertifikat SSL
  Serial.println("Menghubungkan WiFi...");

  // Jika belum bisa terkoneksi
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print("Menghubungkan...");
  }

  // Output pesan jika sudah terkoneksi
  Serial.println("\nWiFi terhubung!");
  bot.sendMessage(CHAT_ID, "üöÄ *ESP32 Gas & Air Quality Monitor*\nPerangkat aktif dan siap memantau kualitas udara! ‚úÖ", "");

  // Input & Output Sensor
  pinMode(MQ2_PIN, INPUT);
  pinMode(MQ135_PIN, INPUT);
  pinMode(BUZZER_PIN, OUTPUT);

  digitalWrite(BUZZER_PIN, LOW); // Buzzer default mati
}

void loop() {
  int mq2Value = analogRead(MQ2_PIN); // Membaca nilai dari sensor mq2
  int mq135Value = analogRead(MQ135_PIN); // Membaca nilai dari sensor mq135

  // tampilkan nilai di serial monitor
  Serial.print("MQ2: ");
  Serial.print(mq2Value);
  Serial.print(" | MQ135: ");
  Serial.print(mq135Value);

  // Buat pesan pemantauan
  String pesanPemantauan = "üìä *Laporan Pemantauan Udara*\n"
                           "-----------------------------\n"
                           "üí® MQ2  (Gas): " + String(mq2Value) + "\n"
                           "üåø MQ135 (Polusi Udara): " + String(mq135Value) + "\n"
                           "-----------------------------\n";

  // cek apakah sensor melewati batas aman
  if (mq2Value > batasAman || mq135Value > batasAman) {
    bot.sendMessage(CHAT_ID, pesanPemantauan + "‚ö†Ô∏è *Status*: Bahaya Terdeteksi!\nüö® Kadar gas/polusi melebihi batas aman.\nMohon segera cek lingkungan Anda!", "");
    digitalWrite(BUZZER_PIN, HIGH); // menyalakan buzzer
  } else {
    bot.sendMessage(CHAT_ID, pesanPemantauan + "‚úÖ *Status*: Aman\nLingkungan dalam kondisi normal. Pemantauan berlanjut... ‚è≥", "");
    digitalWrite(BUZZER_PIN, LOW); // mematikan buzzer
  }

  delay(3000); // pesan dikirim setiap 3 detik
}
